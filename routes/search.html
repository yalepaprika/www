<svelte:head>
  <title>Search</title>
</svelte:head>

<Title title="Search"/>
<div class="x">
  <div class="dn sm-db c2 p1">
    <ul>
      <li><a rel="prefetch" href="/about">About</a></li>
      <li><a rel="prefetch" href="/support">Support</a></li>
      <li><a rel="prefetch" href="/search">Search</a></li>
    </ul>
  </div>
  <div class="c12 sm-c10 p1">
    <form class="mb3" on:submit="search(event)">
      <input class="c10 sm-c8" bind:value=searchQuery type=text>
      <button type=submit>â†’</button>
    </form>
    {#if resultsLength(results)}
      <div class="results c12 xw" transition:fly='{y:20}'>
        {#if results.post && results.post.length}
        <div class="c12 sm-c4">
          <h1>Articles</h1>
          <ul>
            {#each results.post as result}
              <li><h1><a rel='prefetch' href='articles/{result.slug}'>{@html result.title.rendered }</a></h1></li>
            {/each}
          </ul>
        </div>
        {/if}
        {#if results.fold && results.fold.length}
        <div class="c12 sm-c4">
          <h1>Folds</h1>
          <ul>
            {#each results.fold as result}
              <li><h1><a rel='prefetch' href='folds/{result.meta.volume}-{result.meta.number}'>{@html result.title.rendered }</a></h1></li>
            {/each}
          </ul>
        </div>
        {/if}
        {#if results.contributor && results.contributor.length}
        <div class="c12 sm-c4">
          <h1>Contributors</h1>
          <ul>
            {#each results.contributor as result}
              <li><h1><a rel='prefetch' href='contributors/{result.slug}'>{@html result.title.rendered }</a></h1></li>
            {/each}
          </ul>
        </div>
        {/if}
      </div>
    {/if}
  </div>
</div>

<style>
  input {
    border-bottom: 0.2rem solid black;
    font-size: 4rem;
    line-height: 0.9;
    font-weight: 400;
    margin-right: 1rem;
  }
</style>

<script>
  import lunr from 'lunr'
  import fly from 'svelte-transitions-fly';

  export default {
    helpers: {
      resultsLength: (results) => {
        if (!results) return false
        let out = (results.post && results.post.length) ||
          (results.fold && results.fold.length) ||
          (results.contributor && results.contributor.length)
        return out
      }
    },
    components: {
      Title: '../components/Title.html'
    },
    methods: {
      search(e) {
        e.preventDefault();
        const { searchQuery, index } = this.get();
        let tokens = searchQuery.split(' ')
        if (tokens[0]) tokens = tokens.map(token => token + '~1')
        const lunrResults = index.search(tokens.join(' '))
        this.set({
          lunrResults
        })
      }
    },
    transitions: { fly },
    data() {
      return {
        lunrResults: [],
        searchQuery: ''
      }
    },
    async preload({ params, query }) {
      const maskFields = 'resources(id,title/rendered,slug,type,meta(volume,number)),index'
      const res = await this.fetch(`search.json?fields=${maskFields}`)
      if (!res.ok) {
        const message = await res.text()
        return this.error(res.status, message);
      }
      const data = await res.json()
      return {
        resources: data.resources,
        index: lunr.Index.load(data.index)
      }
    },
    computed: {
      results: ({ lunrResults, resources }) => {
        resources = lunrResults.map(result => {
          const resource = resources.filter(resource => {
            return resource.id == result.ref
          })[0]
          return resource
        })
        let out = {}
        for (let resource of resources) {
          if (!out[resource.type]) out[resource.type] = []
          out[resource.type].push(resource)
        }
        return out
      }
    }
  };
</script>