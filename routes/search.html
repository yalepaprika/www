<svelte:head>
  <title>Search</title>
</svelte:head>

<Title title="Search"/>
<div class="x">
  <div class="co2 c10">
      <form class="mb3" on:submit="search(event)">
        <input class="c8" bind:value=searchQuery type=text>
        <button type=submit>â†’</button>
      </form>
  </div>
</div>
{#if results.length}
  <div class="co2 c4" transition:fly='{y:20}'>
    <ul>
      {#each results as result}
        {#if result.type == 'post' }
          <li><a rel='prefetch' href='articles/{result.slug}'>{@html result.title.rendered }</a></li>
        {:elseif result.type == 'fold' }
          <li><a rel='prefetch' href='folds/{result.meta.volume}-{result.meta.number}'>{@html result.title.rendered }</a></li>
        {:else}
          <li><a rel='prefetch' href='contributors/{result.slug}'>{@html result.title.rendered }</a></li>
        {/if}
      {/each}
    </ul>
  </div>
{/if}

<style>
  input {
    border-bottom: 0.2rem solid black;
    font-size: 4rem;
    line-height: 0.9;
    font-weight: 400;
    margin-right: 1rem;
  }
</style>

<script>
  import lunr from 'lunr'
  import fly from 'svelte-transitions-fly';

  export default {
    components: {
      Title: '../components/title.html'
    },
    methods: {
      search(e) {
        e.preventDefault();
        const { searchQuery, index } = this.get();
        let tokens = searchQuery.split(' ')
        if (tokens[0]) tokens = tokens.map(token => token + '~1')
        const lunrResults = index.search(tokens.join(' '))
        this.set({
          lunrResults
        })
      }
    },
    transitions: { fly },
    data() {
      return {
        lunrResults: [],
        searchQuery: ''
      }
    },
    async preload({ params, query }) {
      const maskFields = 'resources(id,title/rendered,slug,type,meta(volume,number)),index'
      const res = await this.fetch(`search.json?fields=${maskFields}`)
      if (!res.ok) {
        const message = await res.text()
        return this.error(res.status, message);
      }
      const data = await res.json()
      return {
        resources: data.resources,
        index: lunr.Index.load(data.index)
      }
    },
    oncreate() {
      console.log(this.get())
    },
    computed: {
      results: ({ lunrResults, resources }) => lunrResults.map(result => {
        const resource = resources.filter(resource => {
          return resource.id == result.ref
        })[0]
        return resource
      }),
    }
  };
</script>